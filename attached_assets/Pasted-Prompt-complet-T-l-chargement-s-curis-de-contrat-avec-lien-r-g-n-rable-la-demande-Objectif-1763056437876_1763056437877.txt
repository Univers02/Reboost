Prompt complet : TÃ©lÃ©chargement sÃ©curisÃ© de contrat (avec lien rÃ©gÃ©nÃ©rable Ã  la demande)
ğŸ¯ Objectif

Mettre en place un systÃ¨me sÃ©curisÃ© permettant Ã  un utilisateur connectÃ© de tÃ©lÃ©charger son contrat PDF depuis son espace personnel, mÃªme plusieurs heures ou jours aprÃ¨s sa gÃ©nÃ©ration.
Le fichier reste chiffrÃ© sur le serveur, et un lien temporaire (5 minutes) est gÃ©nÃ©rÃ© Ã  chaque demande.

âš™ï¸ Technos

Node.js + Express

jsonwebtoken (JWT)

fs + path

Middleware dâ€™authentification

Compatible Render / Replit / Vercel Serverless

ğŸ’» Code complet
import express from "express";
import jwt from "jsonwebtoken";
import fs from "fs";
import path from "path";
import dotenv from "dotenv";
import { authMiddleware } from "./middlewares/auth.js"; // ğŸ” Middleware dâ€™authentification

dotenv.config();
const app = express();

const DOWNLOAD_SECRET = process.env.DOWNLOAD_SECRET || "super_secret_download_key";
const CONTRACTS_DIR = path.join(process.cwd(), "uploads", "contracts");

// âœ… Endpoint 1 : GÃ©nÃ¨re un lien temporaire Ã  la demande
app.get("/api/contracts/:loanId/link", authMiddleware, async (req, res) => {
  try {
    const { loanId } = req.params;

    // Exemple : rÃ©cupÃ©ration du contrat depuis ta BDD
    const contract = await db.contracts.findUnique({ where: { loanId } });
    if (!contract) return res.status(404).json({ error: "Contrat introuvable" });

    // VÃ©rifie que le contrat appartient bien Ã  lâ€™utilisateur connectÃ©
    if (contract.userId !== req.user.id && !req.user.isAdmin) {
      return res.status(403).json({ error: "AccÃ¨s non autorisÃ©" });
    }

    // GÃ©nÃ¨re un lien signÃ© temporaire (valide 5 min)
    const token = jwt.sign(
      { filePath: contract.filePath, userId: req.user.id },
      DOWNLOAD_SECRET,
      { expiresIn: "5m" }
    );

    const signedUrl = `${process.env.BASE_URL}/api/contracts/signed/${token}`;
    res.json({ signedUrl });
  } catch (err) {
    console.error("Erreur gÃ©nÃ©ration lien:", err);
    res.status(500).json({ error: "Erreur interne du serveur" });
  }
});

// âœ… Endpoint 2 : Sert le contrat via lien signÃ© (temporaire)
app.get("/api/contracts/signed/:token", async (req, res) => {
  try {
    const { token } = req.params;
    const decoded = jwt.verify(token, DOWNLOAD_SECRET);

    const filePath = path.resolve(CONTRACTS_DIR, path.basename(decoded.filePath));
    if (!fs.existsSync(filePath)) {
      return res.status(404).json({ error: "Fichier introuvable" });
    }

    // Envoi sÃ©curisÃ© du contrat
    res.download(filePath, `contrat_pret_${Date.now()}.pdf`);
  } catch (err) {
    console.error("Erreur tÃ©lÃ©chargement:", err);
    return res.status(403).json({ error: "Lien invalide ou expirÃ©" });
  }
});

// âœ… Exemple de middleware dâ€™authentification
// (Ã  adapter selon ton systÃ¨me JWT / session)
export function authMiddleware(req, res, next) {
  const token = req.headers.authorization?.split(" ")[1];
  if (!token) return res.status(401).json({ error: "Non authentifiÃ©" });

  try {
    const user = jwt.verify(token, process.env.JWT_SECRET);
    req.user = user;
    next();
  } catch (err) {
    return res.status(403).json({ error: "Token invalide" });
  }
}

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => console.log(`ğŸš€ Serveur en ligne sur le port ${PORT}`));

ğŸ§© .env requis
JWT_SECRET=ta_clef_jwt_principale
DOWNLOAD_SECRET=ta_clef_secrete_pour_liens_temporaire
BASE_URL=https://api.altusfinancegroup.com

ğŸ” Fonctionnement rÃ©sumÃ©

ğŸ‘¨â€ğŸ’¼ Admin approuve une demande â†’ le contrat est gÃ©nÃ©rÃ© et sauvegardÃ© dans /uploads/contracts/.

ğŸ“¦ Base de donnÃ©es contient :

loanId, userId, filePath, status

ğŸ‘¤ Utilisateur clique sur â€œTÃ©lÃ©charger le contratâ€

ğŸ›°ï¸ Le frontend appelle :

const res = await fetch(`/api/contracts/${loanId}/link`, { headers: { Authorization: `Bearer ${token}` }});
const { signedUrl } = await res.json();
window.open(signedUrl, "_blank");


ğŸ” Le backend gÃ©nÃ¨re un lien signÃ© JWT (valide 5 min) et le retourne.

ğŸ’¾ Lâ€™utilisateur tÃ©lÃ©charge le PDF via /api/contracts/signed/:token

â±ï¸ Le lien expire automatiquement aprÃ¨s 5 minutes.

ğŸ” Si lâ€™utilisateur revient plus tard â†’ un nouveau lien est rÃ©gÃ©nÃ©rÃ© Ã  la demande.

ğŸ§± Avantages

âœ… SÃ©curitÃ© maximale (pas de lien permanent ni de partage possible)
âœ… Fonctionne mÃªme si lâ€™utilisateur revient plus tard
âœ… ZÃ©ro dÃ©pendance externe (pas de S3, pas de Cloudinary)
âœ… Compatible Render / Replit / Vercel
âœ… Aucun risque de corruption ou de fuite de fichier
âœ… Facile Ã  tester et Ã  dÃ©boguer