ğŸ§  Objectif

Permettre Ã  lâ€™utilisateur de tÃ©lÃ©verser son contrat signÃ© (PDF, image, etc.) depuis son tableau de bord, afin quâ€™il soit transmis par email Ã  lâ€™administrateur, sans Cloudinary, de maniÃ¨re sÃ©curisÃ©e et lisible.

âš™ï¸ Fonctionnement complet
1. CÃ´tÃ© utilisateur (frontend)

Un bouton ğŸ“„ Envoyer le contrat signÃ© sâ€™affiche quand loan.status === "awaiting_signed_contract".

Lâ€™utilisateur choisit un fichier (PDF, JPG, PNG).

Un formulaire multipart/form-data est envoyÃ© au backend via /api/loans/:loanId/upload-signed-contract.

2. CÃ´tÃ© backend (Node.js + Express + Multer + SendGrid)

Le serveur :

VÃ©rifie lâ€™authentification de lâ€™utilisateur.

VÃ©rifie que le prÃªt correspond bien Ã  cet utilisateur.

Stocke temporairement le fichier.

Lâ€™envoie en piÃ¨ce jointe lisible Ã  lâ€™administrateur via SendGrid.

Met Ã  jour le statut du prÃªt â†’ "awaiting_admin_verification".

Supprime le fichier local aprÃ¨s envoi âœ…

ğŸ’» Prompt complet (Ã  envoyer Ã  Replit)

ğŸ§© Prompt Ã  exÃ©cuter :

CrÃ©e un endpoint sÃ©curisÃ© pour que lâ€™utilisateur puisse tÃ©lÃ©verser son contrat signÃ© et lâ€™envoyer automatiquement Ã  lâ€™administrateur.

ğŸ“‚ Fichier : uploadSignedContract.ts
import express from "express";
import multer from "multer";
import fs from "fs";
import sendgrid from "@sendgrid/mail";
import dotenv from "dotenv";
import { verifyUserSession } from "../middleware/auth"; // Middleware dâ€™authentification
import Loan from "../models/Loan"; // ModÃ¨le du prÃªt (ORM ou Prisma)

dotenv.config();
sendgrid.setApiKey(process.env.SENDGRID_API_KEY);

const router = express.Router();
const upload = multer({ dest: "uploads/signed_contracts/" });

router.post(
  "/:loanId/upload-signed-contract",
  verifyUserSession,
  upload.single("signedContract"),
  async (req, res) => {
    try {
      const { loanId } = req.params;
      const userId = req.user.id;

      // VÃ©rification du prÃªt
      const loan = await Loan.findUnique({ where: { id: loanId } });
      if (!loan || loan.userId !== userId)
        return res.status(403).json({ message: "AccÃ¨s non autorisÃ©" });

      // Lecture du fichier
      const file = req.file;
      const attachment = {
        content: fs.readFileSync(file.path).toString("base64"),
        filename: file.originalname,
        type: file.mimetype,
        disposition: "attachment",
      };

      // Email HTML
      const htmlContent = `
        <div style="font-family: Arial; padding: 20px;">
          <h3>Contrat signÃ© reÃ§u</h3>
          <p><strong>Utilisateur :</strong> ${req.user.name}</p>
          <p><strong>Email :</strong> ${req.user.email}</p>
          <p><strong>ID du prÃªt :</strong> ${loanId}</p>
          <p>Le contrat signÃ© est joint Ã  cet email.</p>
        </div>
      `;

      // Envoi par email
      await sendgrid.send({
        to: "admin@altusfinancegroup.com",
        from: "no-reply@altusfinancegroup.com",
        subject: `Contrat signÃ© reÃ§u - PrÃªt #${loanId}`,
        html: htmlContent,
        attachments: [attachment],
      });

      // Mise Ã  jour du statut
      await Loan.update({
        where: { id: loanId },
        data: { status: "awaiting_admin_verification" },
      });

      // Nettoyage du fichier
      fs.unlinkSync(file.path);

      res.status(200).json({
        success: true,
        message: "Contrat signÃ© envoyÃ© avec succÃ¨s âœ…",
      });
    } catch (error) {
      console.error(error);
      res.status(500).json({
        success: false,
        message: "Erreur lors de l'envoi du contrat signÃ© âŒ",
      });
    }
  }
);

export default router;

ğŸ”’ Avantages de cette mÃ©thode :

âœ… Authentification vÃ©rifiÃ©e (personne dâ€™autre ne peut envoyer Ã  sa place).
âœ… Fichiers lisibles et transmis directement Ã  lâ€™admin.
âœ… Aucun stockage externe.
âœ… Suppression automatique aprÃ¨s envoi.
âœ… Peut Ãªtre reliÃ© Ã  ton systÃ¨me de notification admin existant.