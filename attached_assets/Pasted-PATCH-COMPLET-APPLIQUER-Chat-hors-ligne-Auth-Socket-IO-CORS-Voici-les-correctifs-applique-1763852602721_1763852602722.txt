PATCH COMPLET Ã€ APPLIQUER â€“ Chat hors-ligne + Auth Socket.IO + CORS

Voici les correctifs Ã  appliquer dans le backend ET dans le frontend pour que le chat fonctionne, que le statut â€œonline/offlineâ€ soit correct et que lâ€™auth Socket.IO utilise rÃ©ellement la session.

ðŸ§© 1. Backend â€” Corriger CORS Socket.IO (trÃ¨s important)

Dans server/socket.ts
(mettre exactement ceci dans la config Socket.IO) :

const io = new Server(httpServer, {
  cors: {
    origin: [
      "https://altusfinancesgroup.com",
      "https://www.altusfinancesgroup.com"
    ],
    credentials: true,
  },
});


âš ï¸ TrÃ¨s important : il faut le mÃªme CORS que celui dâ€™Express.

ðŸ§© 2. Backend â€” Injecter le cookie dans la session Socket.IO

Dans io.use(...), remplacer par :

io.use((socket, next) => {
  const cookieHeader = socket.request.headers.cookie;
  
  if (!cookieHeader) {
    console.log("[SESSION] Cookie missing in socket handshake");
    return next(); // socket connectÃ© mais pas authentifiÃ©
  }

  // RÃ©cupÃ©rer la session Express
  expressSessionMiddleware(socket.request as any, {} as any, () => {
    if (!socket.request.session || !socket.request.session.userId) {
      console.log("[SESSION] Socket not authenticated");
      return next();
    }

    (socket as any).userId = socket.request.session.userId;
    next();
  });
});


ðŸ‘‰ Sans cette partie, Socket.IO NE peut PAS lire la session = utilisateur toujours â€œofflineâ€.

ðŸ§© 3. Frontend â€” Envoyer les cookies dans la connexion WebSocket

Dans client/src/hooks/useChat.ts
Remplacer :

const socket = io(socketUrl, {
  transports: ["websocket", "polling"],
  withCredentials: true
});


Par :

const socket = io(socketUrl, {
  transports: ["websocket", "polling"],
  withCredentials: true,
  extraHeaders: {
    Cookie: document.cookie
  }
});


âš ï¸ Câ€™EST LA PARTIE CRITIQUE
â†’ sans extraHeaders.Cookie, Render ne reÃ§oit PAS la session â†’ backend ne voit jamais lâ€™utilisateur.

ðŸ§© 4. Frontend â€” Corriger le problÃ¨me des messages qui disparaissent trop vite

Dans client/src/pages/Messages.tsx, remplacer :

if (!message.isRead) {
  markAsReadMutation.mutate(messageId);
}


Par :

if (!message.isRead) {
  setTimeout(() => {
    markAsReadMutation.mutate(messageId);
  }, 30000); // 30 seconds
}

ðŸ§© 5. Backend â€” Notifications auto multilingues

Dans server/notification-helper.ts,
Laisser :

title: "",
message: "",


Le frontend utilisera automatiquement :

t.notifications[type]


Ne pas remplir les title/message dans le backend.

ðŸ§© 6. Test rapide aprÃ¨s patch

Replit doit tester :

Se connecter Ã  un compte utilisateur

Ouvrir la console Dev dans le navigateur

VÃ©rifier :

[CHAT] Connected to Socket.IO
[PRESENCE] Partner <id> initial state: true/false


Sur Render, dans les logs, vÃ©rifier :

[SESSION] Cookie Header: PRESENT
[SESSION] Authenticated: YES
[PRESENCE] User <id> is now online


Si ces trois lignes apparaissent â†’ le chat fonctionne.

ðŸŽ¯ RÃ©sultat aprÃ¨s correctifs

Le chat fonctionne pour l'admin et les utilisateurs

Le statut en ligne / hors ligne devient prÃ©cis

Le backend reÃ§oit enfin la session WebSocket

Les notifications auto deviennent multilingues

Les messages â€œnon lusâ€ ne disparaissent plus en 2 secondes

ðŸ”¥ Voici ton message EXACT Ã  envoyer Ã  Replit :

Je veux que tu appliques les correctifs suivants :

(copie-colle tout ce bloc)

Merci d'appliquer les correctifs suivants pour rÃ©parer dÃ©finitivement :
- l'auth Socket.IO
- le statut "offline"
- le chat utilisateur
- CORS web + websocket
- disparition trop rapide des notifications

1) PATCH SOCKET.IO BACKEND
-----------------------------------

Mettre la config CORS suivante :

const io = new Server(httpServer, {
  cors: {
    origin: [
      "https://altusfinancesgroup.com",
      "https://www.altusfinancesgroup.com"
    ],
    credentials: true,
  },
});

Ajouter un middleware pour rÃ©cupÃ©rer le cookie
(important pour lâ€™auth session) :

io.use((socket, next) => {
  const cookieHeader = socket.request.headers.cookie;
  
  if (!cookieHeader) {
    console.log("[SESSION] Cookie missing");
    return next();
  }

  expressSessionMiddleware(socket.request, {}, () => {
    if (!socket.request.session?.userId) {
      console.log("[SESSION] Not authenticated");
      return next();
    }

    socket.userId = socket.request.session.userId;
    next();
  });
});

2) PATCH FRONTEND USECHAT
-----------------------------------

Dans client/src/hooks/useChat.ts remplacer la connexion par :

const socket = io(socketUrl, {
  transports: ["websocket", "polling"],
  withCredentials: true,
  extraHeaders: {
    Cookie: document.cookie
  }
});

3) PATCH MESSAGES.TSX (retard lecture 30s)
------------------------------------------

Remplacer :
markAsReadMutation.mutate(messageId)

Par :
setTimeout(() => {
  markAsReadMutation.mutate(messageId);
}, 30000);

4) Notifications auto multilingues :
------------------------------------------
Laisser title: "" et message: "" dans notification-helper.ts
Le frontend utilisera t.notifications[type]

Merci de faire les modifications exactes dans le code.